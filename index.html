<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmitTG Supabase Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .box {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      max-width: 600px;
      margin: auto;
    }
    textarea, input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: none;
      font-family: monospace;
      background: #333;
      color: #fff;
    }
    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .output {
      white-space: pre-wrap;
      background: #000;
      padding: 15px;
      margin-top: 10px;
      border-radius: 8px;
    }
    .btn-list { background: #8e24aa; color: #fff; }
    .btn-save { background: #2e7d32; color: #fff; }
    .btn-show { background: #1565c0; color: #fff; }
    .btn-copy { background: #f57c00; color: #fff; }
    .btn-confirm { background: #00897b; color: #fff; }
    .btn-mono { background: #00acc1; color: #fff; }
    .btn-logout { background: #c62828; color: #fff; }
    button:hover {
      opacity: 0.9;
      transform: scale(1.03);
      transition: 0.2s ease-in-out;
    }
  </style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>üîê Login</h2>
  <input type="text" id="usernameInput" placeholder="Enter your username">
  <button onclick="login()">üö™ Login</button>
</div>

<div class="box" id="mainBox" style="display:none;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div><b>üë§ User:</b> <span id="userShow"></span></div>
    <button onclick="logout()" class="btn-logout">üö™ Logout</button>
  </div>

  <hr>

  <input type="text" id="dateInput" placeholder="üóì Enter Date (e.g., 26 June)">
  <textarea id="listInput" rows="6" placeholder="üìÑ Paste your list..."></textarea>
  <button onclick="saveList()" class="btn-confirm">üíæ Save List</button>

  <hr>

  <input type="text" id="codeInput" placeholder="Enter Code (8/9 chars)" oninput="autoFocusNumber()">
  <input type="number" id="numberInput" placeholder="Enter Number">
  <button onclick="insertCode()" class="btn-save">üíæ Save Code</button>

  <div id="result" class="output"></div>
  <button onclick="copyResult()" class="btn-copy">üìã Copy Output</button>

  <hr>

  <textarea id="monoInput" rows="4" placeholder="üî§ Paste Mono list..."></textarea>
  <button onclick="runMono()" class="btn-mono">‚öôÔ∏è Convert Mono</button>
  <div id="monoResult" class="output"></div>
  <button onclick="copyMono()" class="btn-copy">üìã Copy Mono</button>
</div>

<script>
  const supabase = supabase.createClient(
    "https://xdmzxsguqrfaxyfjxtye.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkbXp4c2d1cXJmYXh5Zmp4dHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzQ5MTEsImV4cCI6MjA2NjUxMDkxMX0.qw9y4pkOJ2JBIFc6PC2_bfjgxJCojlLvU6z_O2OLSfQ"
  );

  let userData = { date: '', list: [], nextIndex: 0 };
  let currentUser = '';

  async function login() {
    const username = document.getElementById("usernameInput").value.trim();
    if (!username) return alert("‚ùå Username required!");
    currentUser = username;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainBox").style.display = "block";
    document.getElementById("userShow").innerText = currentUser;

    const { data } = await supabase
      .from("user_data")
      .select("data")
      .eq("username", currentUser)
      .single();

    if (data) {
      userData = data.data;
      showList();
    }
  }

  async function saveList() {
    const date = document.getElementById("dateInput").value.trim();
    const lines = document.getElementById("listInput").value.trim().split("\n");
    if (!date || lines.length === 0) return alert("‚ùå Date or list missing!");

    let cleaned = [];
    for (let line of lines) {
      line = line.trim();
      if (!line) continue;
      let parts = line.split(/\s+/);
      let serial = parseInt(parts[0]);
      if (!isNaN(serial)) {
        if (line.toLowerCase().includes("del")) {
          cleaned.push({ serial, value: "deleted" });
        } else {
          cleaned.push({ serial, value: parts[parts.length - 1] });
        }
      }
    }

    userData = { date, list: cleaned, nextIndex: 0 };
    await supabase.from("user_data").upsert([{ username: currentUser, data: userData }]);
    alert("‚úÖ List saved!");
    showList();
  }

  async function insertCode() {
    const code = document.getElementById("codeInput").value.trim();
    const number = document.getElementById("numberInput").value.trim();
    if (!code || !number || (code.length !== 8 && code.length !== 9)) {
      alert("‚ùå Invalid code or number");
      return;
    }

    for (let i = userData.nextIndex; i < userData.list.length; i++) {
      let item = userData.list[i];
      if (item.value !== "deleted" && !item.value.includes(" ")) {
        item.value = `${code}   ${number}   ${item.value}`;
        userData.nextIndex = i + 1;
        await supabase.from("user_data").upsert([{ username: currentUser, data: userData }]);
        alert("‚úÖ Code inserted!");
        showList();
        return;
      }
    }

    alert("‚ö†Ô∏è No space left to insert.");
  }

  function showList() {
    let output = `**${userData.date}**\n\n****\n\n`;
    for (let item of userData.list) {
      let val = item.value.replace(/\b([A-Za-z0-9]{8,9})\b/g, "`$1`");
      output += `${item.serial}.   ${val}\n\n`;
    }
    document.getElementById("result").innerText = output;
  }

  function copyResult() {
    navigator.clipboard.writeText(document.getElementById("result").innerText)
      .then(() => alert("üìã Copied!"));
  }

  function runMono() {
    const lines = document.getElementById("monoInput").value.trim().split("\n");
    let output = lines.map(line => line.trim()).filter(line => line).map(line => line.replace(/\b([A-Za-z0-9]{8,9})\b/, "`$1`")).join("\n\n");
    document.getElementById("monoResult").innerText = output;
  }

  function copyMono() {
    navigator.clipboard.writeText(document.getElementById("monoResult").innerText)
      .then(() => alert("üìã Mono Copied!"));
  }

  function autoFocusNumber() {
    const codeField = document.getElementById("codeInput");
    const numberField = document.getElementById("numberInput");
    if (codeField.value.trim().length >= 8) numberField.focus();
  }

  function logout() {
    currentUser = "";
    userData = { date: '', list: [], nextIndex: 0 };
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("mainBox").style.display = "none";
  }
</script>

</body>
</html>
